# Position Independent Shellcode Template 

PoC to create position independent shellcode in nim. This generates quite large shellcode with how nim handles arrays and strings. Nim arrays are supposedly handled on the stack, but it seems that the data is copied over to the `.data` section. Getting the strings on the stack would decrease the size a little bit, but it would still be quite large.

The data access in .data section is referenced relatively to rip, so a linker script is used to move the data section as close to the shellcode as possible to reduce size.

Because the .data section is included, the memory region for the shellcode needs to be RWX.

### Things to modify

A few things need to be modified for creating shellcode. 

1. `main.exe` - the PIC shellcode generated
2. `extract/extract_sc.nim` - `start` and `fin`: The start of the `.text` section to the end of the `.data` section. This can be found with a disassembler and hex editor. 
3. `script.ld` - The location of the `.data` section should be adjusted to be immediately after `.text`

### Creating PIC Shellcode

The shellcode is generated from `main.nim`. 

Compile with: `nim c -d:mingw .\main.nim`

Once compiled, cd into `extract` and run: `nim c -r -d:release --skipParentCfg:on .\extract_sc.nim`

This will generate `sc.bin` in the current dir and print out a formatted array.

Test, cd into `test` and run: `nim c -r -d:release --skipParentCfg:on .\injection.nim`

### References

- [From C, with inline assembly, to shellcode](https://steve-s.gitbook.io/0xtriboulet/just-malicious/from-c-with-inline-assembly-to-shellcode)
- [Bitmancer nim.cfg](https://github.com/zimawhit3/Bitmancer/blob/main/nim.cfg)
- [maldevacademy](https://maldevacademy.com/)
