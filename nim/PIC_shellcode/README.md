# Position Independent Shellcode Template 

PoC to create position independent shellcode in nim. This generates quite large shellcode with how nim compiles. Nim arrays are handled on the stack if they are not called from the top level program. 

### Things to modify

A few things need to be modified for creating shellcode. 

1. `main.exe` - the PIC shellcode generated
2. `extract/extract_sc.nim` - `start` and `fin`: The start of the `.text` section to the end 

A stack string can be written like:
```nim
var sCmd: array[4, char] 
sCmd[0] = 'c'
sCmd[1] = 'm'
sCmd[2] = 'd'
sCmd[3] = '\0'
```

It will be allocated in the `.rdata` section if it written like:
```nim
var sCmd: array[4, char] = ['c','m','d','\0']
```

The data section would need to be handled with a linker script such as (linker flag available in `nim.cfg`):
```ld
SECTIONS
{
  . = 0x140001000;
  .text : { *(.text) }
  . = 0x1400013f0;
  .data : { *(.data) }
}
```

### Creating PIC Shellcode

The shellcode is generated from `main.nim`. 

Compile with: `nim c -d:mingw .\main.nim`

Once compiled, cd into `extract` and run: `nim c -r -d:release --skipParentCfg:on .\extract_sc.nim`

This will generate `sc.bin` in the current dir and print out a formatted array.

Test, cd into `test` and run: `nim c -r -d:release --skipParentCfg:on .\injection.nim`

### References

- [From C, with inline assembly, to shellcode](https://steve-s.gitbook.io/0xtriboulet/just-malicious/from-c-with-inline-assembly-to-shellcode)
- [Bitmancer nim.cfg](https://github.com/zimawhit3/Bitmancer/blob/main/nim.cfg)
- [maldevacademy](https://maldevacademy.com/)
