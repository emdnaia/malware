#[ Source: https://github.com/S3cur3Th1sSh1t/Bitmancer/blob/main/src/Bitmancer/crt/io.nim ]#
import winim
import getmoduleh, getprocaddr

type
  CFile* = object
    cptr*:       cstring
    cnt*:        SIZE_T
    base*:       cstring
    flag*:       SIZE_T
    file*:       SIZE_T
    charBuf*:    SIZE_T
    bufSize*:    SIZE_T
    tmpFname*:   cstring
  CFilePtr* = ptr CFile ## The type representing a file handle.

# Declaring needed functions
type 
  LoadLibraryA       = (proc(lpLibFileName: LPCSTR): HMODULE {.stdcall.})
  ## MSVCRT ---------------------------------------------------------------
  iob_func*   = proc: CFilePtr {.cdecl, gcsafe.}
  fileno*     = proc(f: CFilePtr): SIZE_T {.cdecl, gcsafe.}
  fwrite*     = proc(b: PVOID, size, n: SIZE_T, f: CFilePtr): SIZE_T {.cdecl, gcsafe.}
  set_mode*   = proc(fd, mode: SIZE_T): SIZE_T {.cdecl, gcsafe.}
  fflush*     = proc(stream: CFilePtr): SIZE_T {.cdecl, gcsafe.}

var 
  sKernel32 = "kernel32.dll".cstring
  sLoadLibraryA = "LoadLibraryA".cstring
  siob_func = "__iob_func".cstring
  sfileno = "_fileno".cstring
  sset_mode = "_setmode".cstring
  sfwrite = "fwrite".cstring
  sfflush = "fflush".cstring

proc getiob_func(crtBase: HMODULE): iob_func = return cast[iob_func](getProcAddress(crtBase, addr siob_func[0]))
proc getfileno(crtBase: HMODULE): fileno     = return cast[fileno](getProcAddress(crtBase, addr sfileno[0]))
proc getset_mode(crtBase: HMODULE): set_mode = return cast[set_mode](getProcAddress(crtBase, addr sset_mode[0]))
proc getfwrite(crtBase: HMODULE): fwrite     = return cast[fwrite](getProcAddress(crtBase, addr sfwrite[0]))
proc getfflush(crtBase: HMODULE): fflush     = return cast[fflush](getProcAddress(crtBase, addr sfflush[0]))

proc getAndInitStdout(crtBase: HMODULE): CFilePtr =
  let
    piob_func = getiob_func(crtBase)
    pfile_no = getfileno(crtBase)
    pset_mode = getset_mode(crtBase)
  let cstdout = cast[CFilePtr](cast[int](piob_func()) +% 0x30)
  return cstdout


proc writeStream(crtBase: HMODULE, f: CFilePtr, s: cstring) = 
  let
    pfwrite = getfwrite(crtBase)
    pflush = getfflush(crtBase)
  discard pfwrite(s, 1, s.len, f)
  discard pflush(f)

proc getCrtBase(): HMODULE =
  var 
    smsvcrt = "msvcrt.dll".cstring
    hk32 = getModuleHandle(sKernel32)
    pLoadLibraryA = cast[LoadLibraryA](getProcAddress(hk32, addr sLoadLibraryA[0]))
  return pLoadLibraryA(addr smsvcrt[0])

proc rawWriteStdOut*(s: cstring) = 
  let
    crtBase = getCrtBase()
    cstdout = getAndInitStdout(crtBase)
  writeStream(crtBase, cstdout, s)